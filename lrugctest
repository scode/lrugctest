#!/bin/bash

set -e

jvmopt () {
    echo "--jvmopt=$*"
}

java_bin () {
    if [ -n "$JAVABIN" ]; then
        echo "$JAVABIN"
        return
    fi

    if [ -n "$JAVA_HOME" ]; then
        echo "$JAVA_HOME/bin/java"
        return
    fi

    echo "java"
}

build_jvmopts () {
    if [ -z "$LRUGCTEST_COLLECTOR" ]
    then
        LRUGCTEST_COLLECTOR="g1"
    fi

    jvmopt -XX:+UnlockExperimentalVMOptions
    jvmopt -XX:+UnlockDiagnosticVMOptions

    #jvmopt -Xmaxf=50
    #jvmopt -Xminf=30
    #jvmopt -XX:GCTimeRatio=1
    #jvmopt -XX:-UseAdaptiveSizePolicy
    #jvmopt -XX:+PrintTenuringDistribution
    #jvmopt -XX:+PrintCompilation
    #jvmopt -XX:G1ConfidencePercent=100#
    #jvmopt -XX:G1GCPercent=100
    #jvmopt -XX:G1YoungGenSize=50m
    #jvmopt -XX:NewSize=15m
    #jvmopt -XX:MaxNewSize=15m
    #jvmopt -XX:+PrintTenuringDistribution
    #jvmopt -XX:+PrintHeapAtGC
    #jvmopt -XX:+PrintHeapAtGCExtended

    if [ "$LRUGCTEST_COLLECTOR" = "g1" ]
    then
        jvmopt -XX:+UseG1GC
        jvmopt -XX:MaxGCPauseMillis=50
        jvmopt -XX:GCPauseIntervalMillis=75
        #jvmopt -XX:G1RSetSparseRegionEntries=500
        #jvmopt -XX:+G1PrintParCleanupStats
        #jvmopt -XX:G1PolicyVerbose=1
        #jvmopt -XX:+G1PrintRegionLivenessInfo
        #jvmopt -XX:+G1ParallelRSetUpdatingEnabled
        #jvmopt -XX:+G1ParallelRSetScanningEnabled
    elif [ "$LRUGCTEST_COLLECTOR" = "shenandoah" ]
    then
        jvmopt -XX:+UseShenandoahGC -XX:ShenandoahGCMode=generationa
    elif [ "$LRUGCTEST_COLLECTOR" = "z" ]
    then
        jvmopt -XX:+UseZGC
    elif [ "$LRUGCTEST_COLLECTOR" = "throughput" ]
    then
        jvmopt -XX:+UseParallelGC
    else
        echo "unknown collector: $LRUGCTEST_COLLECTOR" >&2
        exit 1
    fi

    jvmopt -XX:+CITime
    jvmopt -Djava.net.preferIPv4Stack=true
    jvmopt -XX:+PrintCommandLineFlags

    jvmopt -Xlog:gc,safepoint

    jvmopt -Xms2G
    jvmopt -Xmx2G
    jvmopt -Xss256k
}

JVMOPTS="$(build_jvmopts)" || exit 1

bazelisk run //src/main/java/org/scode/lrugctest/cmdline ${JVMOPTS} -- "${@}"
